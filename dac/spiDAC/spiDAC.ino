/*
  spiDAC

  uses mcp4821 to output a waveform
*/

#include <SPI.h>
#define CSPIN 10

void writeDAC(short);

short sinTab[] = {2048,2073,2098,2123,2148,2173,2198,2224,
2249,2274,2299,2324,2349,2373,2398,2423,
2448,2472,2497,2522,2546,2570,2595,2619,
2643,2667,2691,2715,2739,2762,2786,2809,
2832,2856,2879,2902,2925,2947,2970,2992,
3014,3037,3059,3080,3102,3123,3145,3166,
3187,3208,3228,3249,3269,3289,3309,3329,
3349,3368,3387,3406,3425,3443,3462,3480,
3498,3515,3533,3550,3567,3584,3600,3616,
3632,3648,3664,3679,3694,3709,3724,3738,
3752,3766,3779,3793,3806,3819,3831,3843,
3855,3867,3878,3889,3900,3911,3921,3931,
3941,3950,3960,3968,3977,3985,3993,4001,
4008,4015,4022,4029,4035,4041,4046,4052,
4057,4061,4066,4070,4074,4077,4080,4083,
4086,4088,4090,4092,4093,4094,4095,4095,
4095,4095,4094,4093,4092,4091,4089,4087,
4084,4082,4079,4075,4072,4068,4064,4059,
4054,4049,4044,4038,4032,4026,4019,4012,
4005,3997,3989,3981,3973,3964,3955,3946,
3936,3926,3916,3906,3895,3884,3873,3861,
3849,3837,3825,3812,3799,3786,3773,3759,
3745,3731,3716,3702,3687,3672,3656,3640,
3624,3608,3592,3575,3558,3541,3524,3506,
3489,3471,3452,3434,3415,3397,3377,3358,
3339,3319,3299,3279,3259,3239,3218,3197,
3177,3155,3134,3113,3091,3069,3048,3025,
3003,2981,2958,2936,2913,2890,2867,2844,
2821,2797,2774,2750,2727,2703,2679,2655,
2631,2607,2582,2558,2534,2509,2485,2460,
2435,2411,2386,2361,2336,2311,2286,2261,
2236,2211,2186,2161,2136,2110,2085,2060,
2035,2010,1985,1959,1934,1909,1884,1859,
1834,1809,1784,1759,1734,1709,1684,1660,
1635,1610,1586,1561,1537,1513,1488,1464,
1440,1416,1392,1368,1345,1321,1298,1274,
1251,1228,1205,1182,1159,1137,1114,1092,
1070,1047,1026,1004,982,961,940,918,
898,877,856,836,816,796,776,756,
737,718,698,680,661,643,624,606,
589,571,554,537,520,503,487,471,
455,439,423,408,393,379,364,350,
336,322,309,296,283,270,258,246,
234,222,211,200,189,179,169,159,
149,140,131,122,114,106,98,90,
83,76,69,63,57,51,46,41,
36,31,27,23,20,16,13,11,
8,6,4,3,2,1,0,0,
0,0,1,2,3,5,7,9,
12,15,18,21,25,29,34,38,
43,49,54,60,66,73,80,87,
94,102,110,118,127,135,145,154,
164,174,184,195,206,217,228,240,
252,264,276,289,302,316,329,343,
357,371,386,401,416,431,447,463,
479,495,511,528,545,562,580,597,
615,633,652,670,689,708,727,746,
766,786,806,826,846,867,887,908,
929,950,972,993,1015,1036,1058,1081,
1103,1125,1148,1170,1193,1216,1239,1263,
1286,1309,1333,1356,1380,1404,1428,1452,
1476,1500,1525,1549,1573,1598,1623,1647,
1672,1697,1722,1746,1771,1796,1821,1846,
1871,1897,1922,1947,1972,1997,2022,2048};

void setup() {
  pinMode(CSPIN, OUTPUT);
  // initialize serial communication at 9600 bits per second:
  Serial.begin(9600);
  SPI.begin();
  SPI.setClockDivider(SPI_CLOCK_DIV2);
  while(!Serial); //wait until serial communication has begun
}

void loop() {
  int readVal;
  for(int i = 0; i < 512; i++){
    writeDAC(sinTab[i]);
  }
  Serial.println(millis());
}

void writeDAC(short val){
  digitalWrite(CSPIN, LOW);
  SPI.transfer16((0001<<12)|(4095&val)); //config of 0001 --> no shutdown, 1mV per step, no shutdown
  digitalWrite(CSPIN, HIGH);
}

